#!/bin/sh

LINT=$(which swiftlint)

if [[ -e "${LINT}" ]]; then
    echo "ğŸš€  SwiftLint ì‹œì‘..."
    echo "ğŸ”  lint ì ìš© ê²½ë¡œ: $(pwd)"
    count=0
    for file_path in $(git ls-files -m --exclude-from=.gitignore | grep ".swift$"); do
        export SCRIPT_INPUT_FILE_$count=$file_path
        count=$((count + 1))
    done

    # Unstaged/Staged areaì—ì„œ ìˆ˜ì •ëœ swift íŒŒì¼ í™•ì¸
    for file_path in $(git diff --name-only --cached | grep ".swift$"); do
        export SCRIPT_INPUT_FILE_$count=$file_path
        count=$((count + 1))
    done

    export SCRIPT_INPUT_FILE_COUNT=$count

    # lint rule ì •ì˜ íŒŒì¼
    RESULT=$($LINT lint --quiet --use-script-input-files --config .precommitlint.yml)

    if [ "$RESULT" == '' ]; then
        printf "âœ¨  SwiftLintì˜ ëª¨ë“  ruleì„ ì¤€ìˆ˜í–ˆìŠµë‹ˆë‹¤!! ê³ ìƒí•˜ì…¨ìŠµë‹ˆë‹¤ğŸ‘ ğŸ‘ ğŸ‘\n"
    else
        echo ""
        printf "âœ” SwiftLint Failed ì•„ë˜ ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”:\n"
        while read -r line; do
            FILEPATH=$(echo $line | cut -d : -f 1)
            L=$(echo $line | cut -d : -f 2)
            C=$(echo $line | cut -d : -f 3)
            TYPE=$(echo $line | cut -d : -f 4 | cut -c 2-)
            MESSAGE=$(echo $line | cut -d : -f 5 | cut -c 2-)
            DESCRIPTION=$(echo $line | cut -d : -f 6 | cut -c 2-)
            if [ $TYPE == 'warning' ]; then
                printf "\n ğŸš§  $TYPE\n"
            elif [ $TYPE == 'error' ]; then
                printf "\n ğŸš¨  $TYPE\n"
            fi
            printf "    âœ” $FILEPATH:$L:$C\n"
            printf "    ğŸ“Œ $MESSAGE: - $DESCRIPTION\n"
        done <<< "$RESULT"

        printf "\n ğŸš‘  ì»¤ë°‹ì‹¤íŒ¨!! Swiftlint ruleì— ë§ê²Œ ì½”ë“œë¥¼ ë³€ê²½í•´ì£¼ì„¸ìš”:)\n"
        exit 1
    fi
else
    echo "SwiftLintê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤,"
    exit 1
fi